# YouTube 系統增強功能 PRD

## 1. Introduction/Overview

本 PRD 定義了 YouTube 影片摘要系統的四個關鍵增強功能，旨在解決當前系統在資料管理、批次處理和處理精確度方面的問題。這些功能將改善使用者體驗，提高系統的可靠性和效率。

### 主要問題
- 處理失敗後的錯誤快取記錄影響後續處理
- 缺乏批次處理和排程機制
- 無法重新處理特定影片
- timestamped_segments 的時間戳記不精確

## 2. Goals

### 主要目標
1. **提供歷史紀錄管理能力**：允許使用者刪除特定影片的歷史記錄，避免錯誤快取影響
2. **實現批次處理和排程機制**：支援多個 URL 的批次提交和狀態追蹤
3. **改善重試機制**：提供針對特定影片的重新處理功能
4. **修正 timestamp 精確度**：透過語意分析改善 timestamped_segments 的時間戳記準確性

### 次要目標
- 提高系統處理效率
- 減少使用者等待時間
- 增強系統錯誤處理能力

## 3. User Stories

### 歷史紀錄刪除功能
- **As a** 一般用戶，**I want to** 刪除特定影片的歷史記錄，**so that** 我可以重新處理失敗的影片而不受錯誤快取影響

### 排程機制與狀態追蹤
- **As a** 一般用戶，**I want to** 一次提交多個影片 URL，**so that** 我可以批次處理多個影片而不需要逐一提交
- **As a** 一般用戶，**I want to** 查看每個影片的處理狀態，**so that** 我可以了解處理進度

### 重新處理功能
- **As a** 一般用戶，**I want to** 重新處理特定影片，**so that** 我可以在系統問題修復後獲得正確的處理結果

### 推播通知
- **As a** 一般用戶，**I want to** 在影片處理完成時收到通知，**so that** 我不需要持續檢查狀態

### 精確時間戳記
- **As a** 一般用戶，**I want to** 獲得準確的重點時間戳記，**so that** 我可以直接跳到影片的重要片段

## 4. Functional Requirements

### 優先級 1：重試和歷史紀錄刪除功能

#### 4.1 歷史紀錄刪除 API
- **REQ-4.1.1**：系統必須提供 API 端點允許使用者刪除特定影片的歷史記錄
- **REQ-4.1.2**：刪除操作必須清除所有相關的快取資料和處理記錄
- **REQ-4.1.3**：刪除操作必須返回操作成功/失敗的狀態

#### 4.2 重新處理功能
- **REQ-4.2.1**：系統必須提供 API 端點允許重新處理特定影片
- **REQ-4.2.2**：重新處理時必須覆蓋舊的處理結果
- **REQ-4.2.3**：重新處理必須觸發完整的處理流程

### 優先級 2：排程機制和狀態追蹤

#### 4.3 批次處理 API
- **REQ-4.3.1**：系統必須支援一次提交最多 10 個影片 URL
- **REQ-4.3.2**：每個批次提交必須返回唯一的批次 ID
- **REQ-4.3.3**：系統必須將批次中的影片加入處理佇列

#### 4.4 處理狀態追蹤
- **REQ-4.4.1**：系統必須提供以下處理狀態：
  - 排隊中 (queued)
  - 處理中 (processing)
  - 處理影片 metadata (metadata_processing)
  - 總結中 (summarizing)
  - 關鍵字截取中 (keyword_extraction)
  - 完成 (completed)
  - 失敗 (failed)
- **REQ-4.4.2**：系統必須提供 API 端點查詢批次或單個影片的處理狀態
- **REQ-4.4.3**：狀態更新必須即時反映實際處理進度

### 優先級 3：推播通知機制

#### 4.5 通知系統
- **REQ-4.5.1**：系統必須支援輪詢 API 方式的狀態查詢
- **REQ-4.5.2**：系統必須支援推播通知（當使用者設定 webhook 時）
- **REQ-4.5.3**：通知必須包含影片 ID、處理狀態和結果資訊

### 優先級 4：timestamped_segments 改進

#### 4.6 語意分析時間戳記
- **REQ-4.6.1**：系統必須將字幕依語意分析重新分組
- **REQ-4.6.2**：系統必須記錄分組後開頭字串的原始時間戳記
- **REQ-4.6.3**：系統必須使用 embedding 技術在向量空間中搜尋最相關的片段
- **REQ-4.6.4**：系統必須返回分組後開頭字串的原始時間戳記作為重點時間

## 5. Non-Goals (Out of Scope)

- **不支援超過 10 個 URL 的批次處理**
- **不提供即時串流處理**
- **不支援影片內容的即時分析**
- **不提供影片編輯功能**
- **不支援多語言同步翻譯**

## 6. Design Considerations

### UI/UX 考量
- 批次提交介面需要簡潔易用
- 狀態顯示需要清晰的進度指示
- 錯誤訊息需要提供明確的問題描述和解決建議

### API 設計
- 遵循 RESTful 設計原則
- 提供一致的錯誤回應格式
- 支援分頁查詢大批次的處理結果

## 7. Technical Considerations

### 資料庫設計
- 新增批次處理相關的資料表
- 新增狀態追蹤欄位
- 考慮資料庫效能優化

### 佇列系統
- 實作工作佇列來處理批次請求
- 確保佇列的可靠性和錯誤恢復機制
- 考慮併發處理的限制

### 快取管理
- 實作有效的快取清除機制
- 避免快取與資料庫不一致的問題
- 考慮快取的過期策略

### 語意分析技術
- 整合現有的 embedding 技術
- 實作語意分組演算法
- 考慮處理效能和精確度的平衡

### 通知系統
- 實作 webhook 機制
- 確保通知的可靠性
- 處理通知失敗的重試邏輯

## 8. Success Metrics

### 量化指標
- **錯誤快取問題減少**：減少 80% 的因快取問題導致的重複錯誤
- **批次處理效率**：批次處理比單個處理節省 60% 的時間
- **時間戳記精確度**：timestamped_segments 的時間戳記準確率提升至 85%
- **系統可靠性**：重新處理成功率達到 95%

### 質化指標
- 使用者滿意度提升
- 系統錯誤率降低
- 處理流程更加透明
- 使用者操作更加便利

## 9. Open Questions

1. **佇列系統選擇**：使用哪種佇列技術（Redis、RabbitMQ、或內建佇列）？
2. **併發處理限制**：系統同時處理的影片數量上限？
3. **語意分析模型**：使用哪種 embedding 模型來進行語意分析？
4. **通知重試策略**：webhook 失敗時的重試次數和間隔？
5. **資料保存期限**：處理歷史和狀態資料的保存期限？
6. **效能監控**：如何監控批次處理的效能和資源使用？

## 實作優先順序

根據使用者需求，功能實作順序如下：
1. **重試和歷史紀錄刪除功能** (最高優先級)
2. **排程機制和狀態追蹤**
3. **多 URL 批次處理**
4. **timestamped_segments 改進** (最低優先級)